version: 2

sources:
  - name: PUBLIC
    database: AVA_DB
    schema: PUBLIC
    description: "Source tables for DataStage to DBT conversion"
    tables:
      - name: retail_data_mart
        description: "Retail data mart source table containing product, customer, stock, and transaction information"
        columns:
          - name: productid
            description: "Product identifier"
            data_type: INTEGER
          - name: productname
            description: "Name of the product"
            data_type: VARCHAR(255)
          - name: category
            description: "Product category"
            data_type: VARCHAR(255)
          - name: subcategory
            description: "Product sub-category"
            data_type: VARCHAR(255)
          - name: sales
            description: "Sales amount"
            data_type: INTEGER
          - name: quantity
            description: "Quantity sold"
            data_type: INTEGER
          - name: customerid
            description: "Customer identifier - used as grouping key"
            data_type: INTEGER
            tests:
              - not_null
          - name: customername
            description: "Customer name"
            data_type: VARCHAR(255)
          - name: spendingscore
            description: "Customer spending score"
            data_type: INTEGER
          - name: annualincomek
            description: "Customer annual income in thousands"
            data_type: INTEGER
          - name: gender
            description: "Customer gender"
            data_type: VARCHAR(255)
          - name: age
            description: "Customer age"
            data_type: INTEGER
          - name: customertype
            description: "Type of customer"
            data_type: VARCHAR(255)
          - name: stockid
            description: "Stock identifier - used as grouping key"
            data_type: INTEGER
            tests:
              - not_null
          - name: name
            description: "Stock/store name"
            data_type: VARCHAR(255)
          - name: rating
            description: "Stock/store rating"
            data_type: INTEGER
          - name: location
            description: "Stock/store location"
            data_type: VARCHAR(255)
          - name: noofemployees
            description: "Number of employees at stock/store"
            data_type: INTEGER
          - name: invoiceid
            description: "Invoice identifier"
            data_type: VARCHAR(255)
          - name: description
            description: "Transaction description"
            data_type: VARCHAR(255)
          - name: invoicedate
            description: "Invoice date"
            data_type: INTEGER
          - name: price
            description: "Price of item"
            data_type: INTEGER
          - name: country
            description: "Country of transaction"
            data_type: VARCHAR(255)

models:
  - name: DataStage_To_DBT_Conversion_2
    description: "Count of customer transactions aggregated by CustomerID and Stockid. Converted from DataStage job: Count_Customers_Transactions_Job. Version 2 with lowercase column names for Snowflake compatibility."
    config:
      materialized: table
      tags: ['datastage_conversion', 'count_transactions']
      database: AVA_DB
      schema: PUBLIC
      alias: count_customers_transactions
    columns:
      - name: customerid
        description: "Customer identifier - grouping key from retail_data_mart"
        data_type: INTEGER
        tests:
          - not_null
          - relationships:
              to: source('PUBLIC', 'retail_data_mart')
              field: customerid
      - name: stockid
        description: "Stock identifier - grouping key from retail_data_mart"
        data_type: INTEGER
        tests:
          - not_null
          - relationships:
              to: source('PUBLIC', 'retail_data_mart')
              field: stockid
      - name: total_orders_num
        description: "Count of transactions per customerid and stockid combination. Derived from DataStage RecCount() function"
        data_type: INTEGER
        tests:
          - not_null
    meta:
      datastage_job: "Count_Customers_Transactions_Job"
      datastage_stages:
        - name: "RETAIL_DATA_MART"
          type: "Sequential File (Source)"
          operator: "import"
          file: "C:\\case_study\\Output_Data\\RETAIL_DATA_MART.txt"
        - name: "Count_Transactions"
          type: "Aggregator"
          operator: "group"
          method: "sort"
          grouping_keys: ["CustomerID", "Stockid"]
          aggregation: "count"
          count_field: "NumberOfTransactions"
          output_field: "total_orders_num"
        - name: "Count_Customers_Transactions"
          type: "Sequential File (Target)"
          operator: "export"
          file: "C:\\case_study\\Output_Data\\Count_Customers_Transactions.txt"
      conversion_date: "2024"
      conversion_version: "2"
      conversion_notes: "Version 2: Fixed case sensitivity issues. Changed all column and table names to lowercase for Snowflake compatibility. Aggregation logic preserved with GROUP BY and COUNT(*) matching DataStage group operator with sort method."