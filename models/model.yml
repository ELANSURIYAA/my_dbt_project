version: 2

# Source definitions for Snowflake tables
sources:
  - name: public
    database: AVA_DB
    schema: PUBLIC
    tables:
      - name: POLICY_SRC
        description: "Source policy data feed for SCD2 load from POLICY_SYS"
        columns:
          - name: POLICY_ID
            description: "Unique policy business key"
            tests:
              - not_null
              - unique
          - name: POLICY_HOLDER_NAME
            description: "Name of the policy holder"
          - name: POLICY_TYPE
            description: "Type/category of the policy"
          - name: PREMIUM_AMOUNT
            description: "Premium amount for the policy"
          - name: START_DATE
            description: "Policy start date"
          - name: END_DATE
            description: "Policy end date"
          - name: UPDATED_DATE
            description: "Timestamp of last source update"
            tests:
              - not_null
          - name: SOURCE_SYSTEM
            description: "Source system identifier"

      - name: DIM_POLICY
        description: "Policy dimension table (SCD Type 2)"
        columns:
          - name: POLICY_KEY
            description: "Surrogate key for DW usage (auto-increment)"
            tests:
              - not_null
              - unique
          - name: POLICY_ID
            description: "Business key - Policy ID"
            tests:
              - not_null
          - name: POLICY_HOLDER_NAME
            description: "Name of the policy holder"
          - name: POLICY_TYPE
            description: "Type/category of the policy"
          - name: PREMIUM_AMOUNT
            description: "Premium amount for the policy"
          - name: START_DATE
            description: "Policy start date"
          - name: END_DATE
            description: "Policy end date"
          - name: EFFECTIVE_FROM
            description: "SCD Type 2 - Effective start date of this version"
            tests:
              - not_null
          - name: EFFECTIVE_TO
            description: "SCD Type 2 - Effective end date of this version (NULL for current)"
          - name: CURRENT_FLAG
            description: "Y = Current active record, N = Historical"
            tests:
              - not_null
              - accepted_values:
                  values: ['Y', 'N']
          - name: VERSION_NO
            description: "Version number for this policy record"
            tests:
              - not_null
          - name: SOURCE_SYSTEM
            description: "Source system identifier"
          - name: UPDATED_DATE
            description: "Timestamp of last update from source"

# Model definitions
models:
  - name: DataStage_To_DBT_Conversion_4
    description: |
      SCD Type 2 implementation for DIM_POLICY dimension - converted from DataStage job SCD2_DIM_POLICY_Load
      
      This model implements Slowly Changing Dimension Type 2 logic:
      - Detects new records and inserts them with VERSION_NO=1
      - Detects changed records and creates new versions
      - Expires old versions by setting CURRENT_FLAG='N' and EFFECTIVE_TO date
      - Maintains full history of all changes
      
      DataStage Job: SCD2_DIM_POLICY_Load.dsx
      Source: PUBLIC.POLICY_SRC
      Target: PUBLIC.DIM_POLICY
      
      Key Features:
      - Natural key: POLICY_ID
      - Tracked attributes: POLICY_HOLDER_NAME, POLICY_TYPE, PREMIUM_AMOUNT, START_DATE, END_DATE
      - Version management with VERSION_NO
      - Effective dating with EFFECTIVE_FROM and EFFECTIVE_TO
      - Current flag management (Y/N)
      - Data validation and quality checks
      
      Partitioning Strategy:
      - DataStage: Hash partitioning on POLICY_ID
      - Snowflake: Cluster by (POLICY_ID, EFFECTIVE_FROM)
    
    config:
      materialized: table
      cluster_by:
        - POLICY_ID
        - EFFECTIVE_FROM
      tags:
        - datastage_conversion
        - scd_type2
        - dim_policy
    
    columns:
      - name: POLICY_ID
        description: "Business key - Policy ID from source system (natural key for SCD Type 2)"
        tests:
          - not_null
      
      - name: POLICY_HOLDER_NAME
        description: "Name of the policy holder (SCD Type 2 tracked attribute)"
      
      - name: POLICY_TYPE
        description: "Type/category of the policy (SCD Type 2 tracked attribute)"
      
      - name: PREMIUM_AMOUNT
        description: "Premium amount for the policy (SCD Type 2 tracked attribute)"
      
      - name: START_DATE
        description: "Policy start date (SCD Type 2 tracked attribute)"
      
      - name: END_DATE
        description: "Policy end date (SCD Type 2 tracked attribute)"
      
      - name: EFFECTIVE_FROM
        description: "SCD Type 2 - Effective start date of this version (set to current date for new versions)"
        tests:
          - not_null
      
      - name: EFFECTIVE_TO
        description: "SCD Type 2 - Effective end date (NULL for current records, yesterday's date for expired records)"
      
      - name: CURRENT_FLAG
        description: "Y = Current active record, N = Historical record (managed by SCD Type 2 logic)"
        tests:
          - not_null
          - accepted_values:
              values: ['Y', 'N']
      
      - name: VERSION_NO
        description: "Version number for this policy record (increments with each change, starts at 1 for new records)"
        tests:
          - not_null
      
      - name: SOURCE_SYSTEM
        description: "Source system identifier (from POLICY_SRC.SOURCE_SYSTEM)"
      
      - name: UPDATED_DATE
        description: "Timestamp of last update from source system (from POLICY_SRC.UPDATED_DATE)"

    meta:
      datastage_job: SCD2_DIM_POLICY_Load
      datastage_version: Version 4
      conversion_date: 2025-10-29
      
      datastage_stages:
        - name: SRC_POLICY
          type: OracleConnector
          description: "Source: STAGING.POLICY_SRC"
        - name: LOOKUP_DIM_POLICY
          type: Lookup
          description: "Lookup current rows from DWH.DIM_POLICY (CURRENT_FLAG='Y')"
        - name: TRANS_DETECT
          type: Transformer
          description: "Detect new/changed rows and prepare SCD fields"
        - name: SCD_MANAGER
          type: SlowlyChangingDimension
          description: "SCD Type 2 Manager (InsertNewVersion, SetCurrentToNAndSetEndDate)"
        - name: TGT_DIM_POLICY
          type: OracleConnector
          description: "Target: DWH.DIM_POLICY"
      
      validation_rules:
        - "POLICY_ID must not be NULL"
        - "POLICY_HOLDER_NAME must not be NULL"
        - "PREMIUM_AMOUNT must not be NULL and must be >= 0"
        - "START_DATE must not be NULL"
        - "END_DATE must be >= START_DATE if not NULL"
      
      scd_type2_logic:
        natural_key: POLICY_ID
        tracked_attributes:
          - POLICY_HOLDER_NAME
          - POLICY_TYPE
          - PREMIUM_AMOUNT
          - START_DATE
          - END_DATE
        version_column: VERSION_NO
        effective_date_column: EFFECTIVE_FROM
        end_date_column: EFFECTIVE_TO
        current_flag_column: CURRENT_FLAG
        insert_strategy: InsertNewVersion
        expire_strategy: SetCurrentToNAndSetEndDate