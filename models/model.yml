version: 2

sources:
  - name: PUBLIC
    database: AVA_DB
    schema: PUBLIC
    description: "Source tables for DataStage to DBT conversion"
    tables:
      - name: RETAIL_DATA_MART
        description: "Retail data mart source table containing product, customer, stock, and transaction information"

models:
  - name: DataStage_To_DBT_Conversion_4
    description: "Count of customer transactions aggregated by CUSTOMERID and STOCKID. Converted from DataStage job: Count_Customers_Transactions_Job. Version 4 with optimized query structure."
    config:
      materialized: table
      schema: PUBLIC
    columns:
      - name: CUSTOMERID
        description: "Customer identifier - grouping key from RETAIL_DATA_MART"
        data_type: INTEGER
        tests:
          - not_null
      - name: STOCKID
        description: "Stock identifier - grouping key from RETAIL_DATA_MART"
        data_type: INTEGER
        tests:
          - not_null
      - name: TOTAL_ORDERS_NUM
        description: "Count of transactions per CUSTOMERID and STOCKID combination. Derived from DataStage RecCount() function"
        data_type: INTEGER
        tests:
          - not_null
    meta:
      datastage_job: "Count_Customers_Transactions_Job"
      datastage_stages:
        - name: "RETAIL_DATA_MART"
          type: "Sequential File (Source)"
          operator: "import"
          file: "C:\\case_study\\Output_Data\\RETAIL_DATA_MART.txt"
        - name: "Count_Transactions"
          type: "Aggregator"
          operator: "group"
          method: "sort"
          grouping_keys: ["CustomerID", "Stockid"]
          aggregation: "count"
          count_field: "NumberOfTransactions"
          output_field: "total_orders_num"
        - name: "Count_Customers_Transactions"
          type: "Sequential File (Target)"
          operator: "export"
          file: "C:\\case_study\\Output_Data\\Count_Customers_Transactions.txt"
      conversion_date: "2024"
      conversion_version: "4"
      conversion_notes: "Version 4: Optimized query structure with simplified configuration. Removed database config from model config. Using direct SQL query with AVA_DB.PUBLIC.RETAIL_DATA_MART reference. Aggregation logic preserved with GROUP BY and COUNT(*) matching DataStage group operator with sort method. Applied general optimizations as user requested changes without specific details."