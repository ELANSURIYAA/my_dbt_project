version: 2

sources:
  - name: PUBLIC
    database: AVA_DB
    schema: PUBLIC
    description: "Source tables for DataStage to DBT conversion"
    tables:
      - name: RETAIL_DATA_MART
        description: "Retail data mart source table containing product, customer, stock, and transaction information"
        columns:
          - name: productid
            description: "Product identifier"
            data_type: INTEGER
          - name: productname
            description: "Name of the product"
            data_type: VARCHAR(255)
          - name: Category
            description: "Product category"
            data_type: VARCHAR(255)
          - name: SubCategory
            description: "Product sub-category"
            data_type: VARCHAR(255)
          - name: Sales
            description: "Sales amount"
            data_type: INTEGER
          - name: Quantity
            description: "Quantity sold"
            data_type: INTEGER
          - name: CustomerID
            description: "Customer identifier - used as grouping key"
            data_type: INTEGER
            tests:
              - not_null
          - name: customername
            description: "Customer name"
            data_type: VARCHAR(255)
          - name: SpendingScore
            description: "Customer spending score"
            data_type: INTEGER
          - name: AnnualIncomek
            description: "Customer annual income in thousands"
            data_type: INTEGER
          - name: gender
            description: "Customer gender"
            data_type: VARCHAR(255)
          - name: age
            description: "Customer age"
            data_type: INTEGER
          - name: customertype
            description: "Type of customer"
            data_type: VARCHAR(255)
          - name: Stockid
            description: "Stock identifier - used as grouping key"
            data_type: INTEGER
            tests:
              - not_null
          - name: name
            description: "Stock/store name"
            data_type: VARCHAR(255)
          - name: rating
            description: "Stock/store rating"
            data_type: INTEGER
          - name: location
            description: "Stock/store location"
            data_type: VARCHAR(255)
          - name: noofemployees
            description: "Number of employees at stock/store"
            data_type: INTEGER
          - name: Invoiceid
            description: "Invoice identifier"
            data_type: VARCHAR(255)
          - name: Description
            description: "Transaction description"
            data_type: VARCHAR(255)
          - name: InvoiceDate
            description: "Invoice date"
            data_type: INTEGER
          - name: Price
            description: "Price of item"
            data_type: INTEGER
          - name: Country
            description: "Country of transaction"
            data_type: VARCHAR(255)

models:
  - name: DataStage_To_DBT_Conversion_1
    description: "Count of customer transactions aggregated by CustomerID and Stockid. Converted from DataStage job: Count_Customers_Transactions_Job"
    config:
      materialized: table
      tags: ['datastage_conversion', 'count_transactions']
      database: AVA_DB
      schema: PUBLIC
    columns:
      - name: CustomerID
        description: "Customer identifier - grouping key from RETAIL_DATA_MART"
        data_type: INTEGER
        tests:
          - not_null
          - relationships:
              to: source('PUBLIC', 'RETAIL_DATA_MART')
              field: CustomerID
      - name: Stockid
        description: "Stock identifier - grouping key from RETAIL_DATA_MART"
        data_type: INTEGER
        tests:
          - not_null
          - relationships:
              to: source('PUBLIC', 'RETAIL_DATA_MART')
              field: Stockid
      - name: total_orders_num
        description: "Count of transactions per CustomerID and Stockid combination. Derived from DataStage RecCount() function"
        data_type: INTEGER
        tests:
          - not_null
    meta:
      datastage_job: "Count_Customers_Transactions_Job"
      datastage_stages:
        - name: "RETAIL_DATA_MART"
          type: "Sequential File (Source)"
          operator: "import"
          file: "C:\\case_study\\Output_Data\\RETAIL_DATA_MART.txt"
        - name: "Count_Transactions"
          type: "Aggregator"
          operator: "group"
          method: "sort"
          grouping_keys: ["CustomerID", "Stockid"]
          aggregation: "count"
          count_field: "NumberOfTransactions"
          output_field: "total_orders_num"
        - name: "Count_Customers_Transactions"
          type: "Sequential File (Target)"
          operator: "export"
          file: "C:\\case_study\\Output_Data\\Count_Customers_Transactions.txt"
      conversion_date: "2024"
      conversion_version: "1"
      conversion_notes: "Initial conversion from DataStage to DBT. Aggregation logic preserved with GROUP BY and COUNT(*) matching DataStage group operator with sort method."